<html>
  <body>
    <h1>DEMO: ALPR</h1>
    <p id="status">TensorFlow.JS is loading...</p>
    <!--<p id="status1">OpenCV is loading...</p>-->
    <p>Input image</p>
    <img src="Images/14CE754.jpg" id="imgSource" alt="Smiley face" height="500" width="500">
    <canvas id="canvasOutput" ></canvas>
  </body>
  <script>
    function onTfJsReady(){
      document.getElementById('status').innerHTML = 'TensorFlow.JS is ready.';
    }
  </script>
  
  <!--<script src="https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.15.1/dist/numjs.min.js"></script>-->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.13.0" onload="onTfJsReady();"> </script>
  <script src="ES-Iter-master/src/Iter.js" type="text/javascript"></script>
  <!--<script>
  //function onOpenCvReady() {
      //document.getElementById('status1').innerHTML = 'OpenCV.JS is ready.';
    //}
  //</script>-->
  <!--<script src="openCV-js-master/openCV-js-master/opencv.js" onload="onOpenCvReady();"  type="text/javascript"></script>-->
  <script>
    let letters = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'P', 'R', 'T', 'U', 'W', 'X', 'Y', 'Z', ''];
    let image = tf.fromPixels(imgSource);
    //var Iter = require('ES-Iter-master/src/Iter.js');
    //let dsize = new cv.Size(128, 64);
    //cv.cvtColor(image, image, cv.COLOR_BGR2GRAY, 0);
    //cv.resize(image, image, dsize);
    image = tf.image.resizeBilinear(image, [128, 64]);
    image = image.mean(2);
    //image = tf.reshape(image, [64, 128]);
    image = tf.cast(image,'float32');
    image = tf.expandDims(image, -1);
    image = tf.expandDims(image, 0);
    
    async function predict(image){
      console.log("Model loading...");
      const model = await tf.loadModel("model4jszp/model.json");
      console.log("Model loaded.");
      out = model.predict(image);
      return out;
    }
    out = predict(image);
    function decode_batch(out){
      ret = "";
      for(j=0; j<=out.shape[0]; j++){
        outbest = tf.argmax(out.slice([j,2], [0,32]));
        outbest = Iter(outbest).groupBy();
        outstr = "";
        for(c in outbest){
          if(c<letters.length){
            outstr = outstr.concat(letters[c]);
          }          
        }
        ret.concat(outstr);
      }
      return   ret; 
    }
    predText = decode_batch(out);
    console.log(predText);
 </script>

</html>
